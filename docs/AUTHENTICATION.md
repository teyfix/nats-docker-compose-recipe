# NATS JWT Authentication Setup (NSC)

This document explains how to set up **JWT-based authentication** for NATS using
`nsc`. It is intentionally **deployment-agnostic** and focuses purely on
concepts, commands, and verification.

All commands are executed using the official
[`natsio/nats-box:0.19.2`](https://hub.docker.com/r/natsio/nats-box) Docker
image.

## Table of Contents

- [NATS JWT Authentication Setup (NSC)](#nats-jwt-authentication-setup-nsc)
  - [Table of Contents](#table-of-contents)
  - [Conceptual overview](#conceptual-overview)
  - [1. Creating the operator](#1-creating-the-operator)
    - [What does `account-jwt-server-url` actually do?](#what-does-account-jwt-server-url-actually-do)
  - [2. Creating an account](#2-creating-an-account)
  - [3. Generating the resolver configuration](#3-generating-the-resolver-configuration)
  - [4. Starting the NATS server](#4-starting-the-nats-server)
  - [5. Pushing account data to NATS](#5-pushing-account-data-to-nats)
  - [6. Debugging and inspection](#6-debugging-and-inspection)
    - [Listing operators](#listing-operators)
    - [Listing accounts](#listing-accounts)
    - [Listing keys](#listing-keys)
    - [Listing seeds (private keys)](#listing-seeds-private-keys)
  - [7. Inspecting account details](#7-inspecting-account-details)
  - [8. Keys used for signing user JWTs](#8-keys-used-for-signing-user-jwts)
    - [Account public key (issuer)](#account-public-key-issuer)
    - [Account signing key (private)](#account-signing-key-private)
    - [Extracting the signing seed](#extracting-the-signing-seed)
  - [9. Example: signing a user JWT](#9-example-signing-a-user-jwt)
  - [10. How This Maps to This Repository](#10-how-this-maps-to-this-repository)

---

## Conceptual overview

NATS JWT authentication has three core entities:

- **Operator** The root authority. Owns accounts and defines global trust.

- **Account** Represents an isolated namespace with its own limits, users, and
  permissions.

- **User JWTs** Short-lived credentials signed by an account that define
  publish/subscribe permissions.

This guide walks through creating each layer in the correct order.

---

## 1. Creating the operator

Create a new operator with a system account and signing key:

```sh
nsc add operator --generate-signing-key --sys --name my_operator
```

```txt
[ OK ] generated and stored operator key "OBBMNDXWHOYLA5CMH47QKAKLEIHKGIZBXIH63WSPHPDHDSAQI7SBGITC"
[ OK ] added operator "my_operator"
[ OK ] When running your own nats-server, make sure they run at least version 2.2.0
[ OK ] created operator signing key: OADCCYB6VSDLBRWHFAITYPCCLXYSCVAEJG546B7UBLHZTJXYW3IUWDGJ
[ OK ] created system_account: name:SYS id:ADPWZT7BFKFGQNCLBGPGS5JYEL63E5E2U3R2NXB2Q37VFEDVU7BXB75X
[ OK ] created system account user: name:sys id:UBUKIFZBXVJQDITR4JBWJORJSDAYU32UFTZGUSILNYWHIIPEU6ISVJJ7
[ OK ] system account user creds file stored in `/nsc/nkeys/creds/my_operator/SYS/sys.creds`
```

Enforce signing-key usage and configure the account JWT resolver URL:

```sh
nsc edit operator --require-signing-keys --account-jwt-server-url "nats://0.0.0.0:4222"
```

```txt
[ OK ] strict signing key usage set to: true
[ OK ] set account jwt server url to "nats://0.0.0.0:4222"
[ OK ] edited operator "my_operator"
```

### What does `account-jwt-server-url` actually do?

When `account-jwt-server-url` is set, the NATS server knows **where to fetch
account JWTs from**.

In this setup, the server is configured to:

- Fetch account claims **from itself**
- Use the embedded resolver generated by `nsc`

This means:

- No external JWT server is required
- Account updates are pushed directly via `nsc push`
- The server remains fully self-contained

This is the simplest and most common production setup for single-cluster NATS.

---

## 2. Creating an account

Create a new account under the operator:

```sh
nsc add account my_account
```

```txt
[ OK ] generated and stored account key "ABT6QBISNJWXEW5QGCSWV6WWYZWOXEHU6G54XPA44ANTXO7EHXTIH6NI"
[ OK ] added account "my_account"
```

Generate an **account signing key**. This key will later be used to sign user
JWTs:

```sh
nsc edit account my_account --sk generate
```

```txt
[ OK ] added signing key "AAAAKEVGK3YQSLEEYDHHD36ETWKWAZZHWFFDDIZW3FINAVWYCHOEXW6A"
[ OK ] edited account "my_account"
```

---

## 3. Generating the resolver configuration

NATS uses a **JWT resolver** to fetch account claims. Generate the resolver
configuration:

```sh
nsc generate config --nats-resolver --sys-account SYS > ./resolver.conf
```

---

## 4. Starting the NATS server

Start NATS with the generated resolver configuration:

```sh
nats -c resolver.conf
```

Alternatively, you can include this config in your `nats.conf` file:

```conf
# NATS Clients Port
port: 4222

# Other configuration options

# NATS JWT Resolver
include ./resolver.conf
```

Then you can start the server as usual:

```sh
nats -c nats.conf
```

---

## 5. Pushing account data to NATS

After starting the NATS server (with `resolver.conf` included), publish all
account JWTs to the running server:

> [!NOTE]  
> Make sure you are in the same environment where you created the operator and
> account (see [Creating the Operator](#1-creating-the-operator) and
> [Creating the Account](#2-creating-an-account)).

```sh
nsc push -A
```

This ensures that all accounts and signing keys are available to the server for
authentication.

---

## 6. Debugging and inspection

### Listing operators

```sh
nsc list operators
```

```txt
+------------------------------------------------------------------------+
|                               Operators                                |
+-------------+----------------------------------------------------------+
| Name        | Public Key                                               |
+-------------+----------------------------------------------------------+
| my_operator | OBBMNDXWHOYLA5CMH47QKAKLEIHKGIZBXIH63WSPHPDHDSAQI7SBGITC |
+-------------+----------------------------------------------------------+
```

---

### Listing accounts

```sh
nsc list accounts
```

```txt
+-----------------------------------------------------------------------+
| Accounts                                                              |
+------------+----------------------------------------------------------+
| Name       | Public Key                                               |
+------------+----------------------------------------------------------+
| SYS        | ADPWZT7BFKFGQNCLBGPGS5JYEL63E5E2U3R2NXB2Q37VFEDVU7BXB75X |
| my_account | ABT6QBISNJWXEW5QGCSWV6WWYZWOXEHU6G54XPA44ANTXO7EHXTIH6NI |
+------------+----------------------------------------------------------+
```

---

### Listing keys

```sh
nsc list keys
```

```txt
+-----------------------------------------------------------------------------------------------+
|                                             Keys                                              |
+-------------+----------------------------------------------------------+-------------+--------+
| Entity      | Key                                                      | Signing Key | Stored |
+-------------+----------------------------------------------------------+-------------+--------+
| my_operator | OBBMNDXWHOYLA5CMH47QKAKLEIHKGIZBXIH63WSPHPDHDSAQI7SBGITC |             | *      |
| my_operator | OADCCYB6VSDLBRWHFAITYPCCLXYSCVAEJG546B7UBLHZTJXYW3IUWDGJ | *           | *      |
|  my_account | ABT6QBISNJWXEW5QGCSWV6WWYZWOXEHU6G54XPA44ANTXO7EHXTIH6NI |             | *      |
|  my_account | AAAAKEVGK3YQSLEEYDHHD36ETWKWAZZHWFFDDIZW3FINAVWYCHOEXW6A | *           | *      |
+-------------+----------------------------------------------------------+-------------+--------+
```

---

### Listing seeds (private keys)

> [!CAUTION]  
> Signing keys are secrets and must be treated with care.

```sh
nsc list keys --show-seeds
```

```txt
+----------------------------------------------------------------------------------------+
|                                       Seeds Keys                                       |
+-------------+------------------------------------------------------------+-------------+
| Entity      | Private Key                                                | Signing Key |
+-------------+------------------------------------------------------------+-------------+
| my_operator | SOAE4GW4K7BYO2327I3GE2ZQILOTNGV4QEOC4DYFKN6UG6E5BZIAIIMRNA |             |
| my_operator | SOAPQQCSOBMMSSZS4NFAQ4BLXSTAMMD5E3XOG547VPEHKPTM6YFPX2YM7Y | *           |
|  my_account | SAACZEZRPNTFT2NKAB726KSNVOAUEMY5PFMBPK27GDXC7CCNLRHU3S77UM |             |
|  my_account | SAALMQV2WCX4XF2GZCUCSS2NIF5KD7CFMNLN27N6IWKIEJKOL5Y7NYB57M | *           |
+-------------+------------------------------------------------------------+-------------+
```

---

## 7. Inspecting account details

Describe the account in JSON form:

```sh
nsc describe account --name=my_account --json
```

```json
{
  "iat": 1765913025,
  "iss": "OADCCYB6VSDLBRWHFAITYPCCLXYSCVAEJG546B7UBLHZTJXYW3IUWDGJ",
  "jti": "QIN2SKKOP4FWIRQRESC6DCEWL4BTOPNAHJUSWPMLMAR4ISSM3IAA",
  "name": "my_account",
  "nats": {
    "authorization": {},
    "default_permissions": {
      "pub": {},
      "sub": {}
    },
    "limits": {
      "conn": -1,
      "consumer": -1,
      "data": -1,
      "disk_max_stream_bytes": -1,
      "exports": -1,
      "imports": -1,
      "leaf": -1,
      "max_ack_pending": -1,
      "mem_max_stream_bytes": -1,
      "payload": -1,
      "streams": -1,
      "subs": -1,
      "wildcards": true
    },
    "signing_keys": [
      "AAAAKEVGK3YQSLEEYDHHD36ETWKWAZZHWFFDDIZW3FINAVWYCHOEXW6A"
    ],
    "type": "account",
    "version": 2
  },
  "sub": "ABT6QBISNJWXEW5QGCSWV6WWYZWOXEHU6G54XPA44ANTXO7EHXTIH6NI"
}
```

---

## 8. Keys used for signing user JWTs

### Account public key (issuer)

This value is referenced as `issuer_account` when encoding user JWTs:

```sh
nsc describe account --name=my_account --json | jq -r '.sub'
```

```txt
ABT6QBISNJWXEW5QGCSWV6WWYZWOXEHU6G54XPA44ANTXO7EHXTIH6NI
```

---

### Account signing key (private)

This key signs user JWTs:

```sh
nsc describe account --name=my_account --json | jq -r '.nats.signing_keys[0]'
```

```txt
AAAAKEVGK3YQSLEEYDHHD36ETWKWAZZHWFFDDIZW3FINAVWYCHOEXW6A
```

---

### Extracting the signing seed

Locate the signing seed under `/nsc/nkeys/keys`:

```sh
nsc describe account --name my_account --json | jq -r '.nats.signing_keys[0]' | xargs -I% find /nsc/nkeys/keys -name '%.nk' -exec cat {} \;
```

> [!CAUTION]  
> Signing keys are secrets and must be treated with care.

```txt
SAALMQV2WCX4XF2GZCUCSS2NIF5KD7CFMNLN27N6IWKIEJKOL5Y7NYB57M
```

---

## 9. Example: signing a user JWT

```js
const accountKey = "..."; // account public key
const accountSeed = "..."; // account signing seed

const accountKeyPair = fromSeed(encodeText(accountSeed));

const jwt = await encodeUser(
  "user-id",
  userKeyPair,
  accountKeyPair,
  {
    issuer_account: accountKey,
    pub: { allow: ["users.id.>"], deny: [] },
    sub: { allow: ["users.id.>"], deny: [] },
  },
  { exp: Math.floor(Date.now() / 1000) + 30 * 60 }
);
```

This JWT can now be used by clients to authenticate with NATS.

```js
import { connect, credsAuthenticator } from "nats.ws";

const nc = await connect({ authenticator: credsAuthenticator(creds) });
```

After connecting to NATS, if the client tries to access a resource it should not
have access to, it will be denied.

```js
try {
  for await (const msg of nc.subscribe("users.prohibited.subject")) {
  }
} catch (err) {
  if (/Permissions.Violation/i.test(String(err))) {
    console.info("Expected permissions violation error.");
  } else {
    throw err;
  }
}
```

On the other hand, if the client tries to access a resource it should have
access to, it will be allowed.

```js
for await (const msg of nc.subscribe("users.id.subject")) {
  console.info(msg.data); // UInt8Array
}
```

## 10. How This Maps to This Repository

This document describes the conceptual steps. In this repository, they are
automated as follows:

- **Steps 1–3**

  - Performed by the `nats-init` container
  - Operator, account, signing keys, and resolver config are generated once

- **Step 4**

  - `nats-server` starts with the generated resolver configuration

- **Step 5**

  - `nats-push` runs `nsc push -A` after the server becomes healthy

- **Steps 8–9**

  - `nats-export` extracts the account signing key
  - Used by application services to mint user JWTs

The repository intentionally separates **bootstrap**, **runtime**, and
**credential export** into distinct containers to keep authority boundaries
explicit.
